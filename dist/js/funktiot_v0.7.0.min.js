function TrainLocation(e,t,n,i,a){this.trainNumber=e,this.Lat=t,this.Long=n,this.Speed=i,this.Time=new Date(a)}function Vessel(e,t,n,i,a,o,r,s,l,d,c,u,m){this.Mmsi=e,this.Lat=t,this.Long=n,this.Heading=i,this.Rot=a,this.Cog=o,this.Sog=r,this.Time=new Date(s),this.Name=l,this.Draught=d,this.Callsign=c,this.Eta=u,this.Destination=m}function HSL(e,t,n,i,a,o,r,s,l,d,c,u,m,p,h,g){this.Type=e,this.Desi=t,this.Dir=n,this.Oper=i,this.Veh=i,this.Time=new Date(o),this.Spd=r,this.Hdg=s,this.Lat=l,this.Long=d,this.Acc=c,this.Dl=u,this.Odo=m,this.Drst=p,this.Start=h,this.Dest=g,this.HSLidentifier=i+"/"+a}function TrainInfo(e,t,n,i){this.Operator=e,this.Type=t,this.Category=n,this.Stations=i}function Station(e,t,n,i,a,o,r,s,l,d){this.UICCode=e,this.Stopping=t,this.ScheduledArrival=n,this.ActualArrival=i,this.ArrivalDifference=a,this.ScheduledDeparture=o,this.ActualDeparture=r,this.DepartureDifference=s,this.Causes=l,this.Passed=d}function Wagon(e,t,n){this.Type=e,this.Palvelut=t,this.Position=n}function compositionJourneySection(e,t,n,i,a){this.Composition=e,this.MaxSpeed=t,this.Length=n,this.From=i,this.To=a}function GeoJSONgeometry(e,t){return JSON.stringify({type:"Point",coordinates:[t,e]})}function GeoJSONtrain(e){return'{"type":"Feature","properties":{"TrainNumber":'+e.trainNumber+',"category":"'+e.trainCategory+'","speed":'+e.Speed+'},"geometry":'+GeoJSONgeometry(e.Lat,e.Long)+"}"}function GeoJSONstation(e){return'{\n"type":"Feature",\n"properties":{\n"name":"'+e.stationName+'",\n"marker-color":"blue",\n"line":"blue"\n},"geometry":'+GeoJSONgeometry(e.latitude,e.longitude)+"}"}function GeoJSONtrainsCollection(e){let t='{"type":"FeatureCollection","features":[';if(0!=e.length){t+=GeoJSONtrain(e[0]);for(var n=1;n<e.length;n++)t=t+","+GeoJSONtrain(e[n])}return t+="]}"}function GeoJSONstationsCollection(e){let t='{"type":"FeatureCollection",\n"features": [';var n=0;if(0!=trainStations.length){for(;n<e.length-1;){if(1==e[n].passengerTraffic){t+=GeoJSONstation(e[0]),n++;break}n++}for(var i=n;i<e.length;i++)1==e[i].passengerTraffic&&(t=t+","+GeoJSONstation(e[i]))}return t+="]}"}function HttpReq(e,t){let n=new XMLHttpRequest;n.addEventListener("load",t),n.open("GET",e),n.send()}function parseTrainLocationMessage(e,t){let n;try{n=JSON.parse(e)}catch(e){return void console.warn("Cannot parse location message"+e)}let i=new TrainLocation(n.trainNumber,n.location.coordinates[1],n.location.coordinates[0],n.speed,Date.now()),a=searchTrainFromArray(i.trainNumber,t);null==a?t.push(i):t[a]=i,removeOldTrains(t),i.trainNumber==selectedTrain&&(document.getElementById("speed").innerHTML=i.Speed)}function parseTrainMessage(e,t){let n;createTimetable("stationsTable",parseStations((n=1==t?JSON.parse(e)[0]:JSON.parse(e)).timeTableRows),!1,!1),resizeAllGridItems(),1==t&&HttpReq("https://rata.digitraffic.fi/api/v1/compositions/")}function searchTrainFromArray(e,t){for(i=0;i<t.length;i++)if(t[i].trainNumber==e)return i}function removeOldTrains(e){let t=Date.now();t-=6e4,t=new Date(t),e.forEach(function(n,i){n.Time<t&&e.splice(i,1)})}function isLocoInFront(e){e.forEach(function(e){if(1==e.position)return!0})}function parseComposition(e){let t,n=[];try{(t=JSON.parse(e).journeySections).forEach(function(e){let t=[],i=e.locomotives,a=e.wagons,o=0,r=0;1==isLocoInFront(i)?r=i.length:o=a.length,i.forEach(function(e){"Electric"==e.powerType?t.push(new Wagon(e.locomotiveType,["electric"],e.location+o)):t.push(new Wagon(e.locomotiveType,["diesel"],e.location+o))}),a.forEach(function(e){let n=[];1==e.pet&&n.push("pet"),1==e.video&&n.push("video"),1==e.catering&&n.push("catering"),1==e.playground&&n.push("playground"),1==e.luggage&&n.push("luggage"),1==e.smoking&&n.push("smoking"),1==e.disabled&&n.push("disabled"),null==e.wagonType?t.push(new Wagon("-",n,e.location+r)):t.push(new Wagon(e.wagonType,n,e.location+r))}),t=t.sort(function(e,t){return e.Position-t.Position}),n.push(new compositionJourneySection(t,e.maximumSpeed,e.totalLength,e.beginTimeTableRow.stationUICCode,e.endTimeTableRow.stationUICCode))})}catch(e){console.warn("Train has no composition data or some other error happened"),n=[]}return n}function parseStations(e){let t=[];for(var n=0;n<e.length;n++){let i=e[n];if(n>=e.length-1)null==i.actualTime?t.push(new Station(i.stationUICCode,i.trainStopping,i.scheduledTime,i.liveEstimateTime,i.differenceInMinutes,void 0,void 0,void 0,i.causes,!1)):t.push(new Station(i.stationUICCode,i.trainStopping,i.scheduledTime,i.actualTime,i.differenceInMinutes,void 0,void 0,void 0,i.causes,!0));else{let a=e[n+1];if(i.stationUICCode==a.stationUICCode){let e,o,r;e=null==i.actualTime?i.liveEstimateTime:i.actualTime,null==a.actualTime?(o=a.liveEstimateTime,r=!1):(o=a.actualTime,r=!0),t.push(new Station(i.stationUICCode,i.trainStopping,i.scheduledTime,e,i.differenceInMinutes,a.scheduledTime,o,a.differenceInMinutes,i.causes.concat(a.causes),r)),n++}else null==i.actualTime?t.push(new Station(i.stationUICCode,i.trainStopping,void 0,void 0,void 0,i.scheduledTime,i.liveEstimateTime,i.differenceInMinutes,i.causes,!1)):t.push(new Station(i.stationUICCode,i.trainStopping,void 0,void 0,void 0,i.scheduledTime,i.actualTime,i.differenceInMinutes,i.causes,!0))}}return t}function compositionTableLine(e,t){let n=t.insertRow(-1),i="";e.Palvelut.forEach(function(e){let t="";"electric"==e&&(t="flash_on"),"diesel"==e&&(t="local_gas_station"),"pet"==e&&(t="pets"),"video"==e&&(t="personal_video"),"catering"==e&&(t="restaurant"),"playground"==e&&(t="child_friendly"),"luggage"==e&&(t="work"),"smoking"==e&&(t="smoking_rooms"),"disabled"==e&&(t="accessible"),i=i+t+" "}),n.insertCell(-1).appendChild(document.createTextNode(e.Position)),n.insertCell(-1).appendChild(document.createTextNode(e.Type));let a=n.insertCell(-1);a.appendChild(document.createTextNode(i)),a.classList.add("material-icons")}function createOneCompositionTable(e,t){let n=document.createElement("div"),i=document.createElement("div");i.classList.add("tableName"),i.appendChild(document.createTextNode(UICCodeToStationName(e.From,trainStations)+" - "+UICCodeToStationName(e.To,trainStations))),n.appendChild(i);let a=document.createElement("table"),o=a.insertRow(-1);o.classList.add("lihava"),o.insertCell(-1).appendChild(document.createTextNode("#")),o.insertCell(-1).appendChild(document.createTextNode("Tunnus")),o.insertCell(-1).appendChild(document.createTextNode("Palvelut")),e.Composition.forEach(function(e){compositionTableLine(e,a)});let r=a.insertRow(-1);r.classList.add("CompositionFooterLined");let s=r.insertCell(-1),l=r.insertCell(-1);s.colSpan="2",s.classList.add("lihava"),s.appendChild(document.createTextNode("Pituus: ")),l.appendChild(document.createTextNode(e.Length+" m"));let d=a.insertRow(-1);d.setAttribute("style","background-color: white; border-top: lightgray 1px solid;");let c=d.insertCell(-1),u=d.insertCell(-1);c.colSpan="2",c.classList.add("lihava"),c.appendChild(document.createTextNode("Maksiminopeus: ")),u.appendChild(document.createTextNode(e.MaxSpeed+" km/h")),n.appendChild(a),t.appendChild(n)}function createCompositionTables(e,t){let n=Date.now(),i=document.getElementById(e);i.innerHTML="",t.forEach(function(e){createOneCompositionTable(e,i)}),i.innerHTML="",t.forEach(function(e){createOneCompositionTable(e,i)});let a=Date.now()-n;console.log("Composition time: "+new Date(a).getMilliseconds()+" ms")}function prettyTime(e){let t,n=new Date(e),i=n.getHours(),a=n.getMinutes();return 1==isNaN(i)?"--:--":(t=i<10?"0"+i+":":i+":",a<10?t=t+"0"+a:t+=a,t)}function UICCodeToStationName(e,t){let n=t.findIndex(function(t){return t.stationUICCode==e});return t[n].stationName.replace("asema","")}function timetableRow(e,t){let n,i,a,o,r=e.insertRow(-1),s=r.insertCell(-1),l=document.createElement("span");null==t.ScheduledArrival?(n=document.createTextNode("-"),i=document.createTextNode("")):(null!=t.ActualArrival&&0!=t.ArrivalDifference?(i=document.createTextNode(prettyTime(t.ActualArrival)),n=document.createTextNode(" ("+prettyTime(t.ScheduledArrival)+")")):(i=document.createTextNode(""),n=document.createTextNode(prettyTime(t.ScheduledArrival))),t.ArrivalDifference>0&&l.classList.add("red"),t.ArrivalDifference<0&&l.classList.add("green")),l.appendChild(i),s.appendChild(l),s.appendChild(n),r.insertCell(-1).appendChild(document.createTextNode(UICCodeToStationName(t.UICCode,trainStations)));let d=r.insertCell(-1),c=document.createElement("span");null==t.ScheduledDeparture?(a=document.createTextNode("-"),o=document.createTextNode("")):(null!=t.ActualDeparture&&0!=t.DepartureDifference?(o=document.createTextNode(prettyTime(t.ActualDeparture)),a=document.createTextNode(" ("+prettyTime(t.ScheduledDeparture)+")")):(o=document.createTextNode(""),a=document.createTextNode(prettyTime(t.ScheduledDeparture))),t.DepartureDifference>0&&c.classList.add("red"),t.DepartureDifference<0&&c.classList.add("green")),c.appendChild(o),d.appendChild(c),d.appendChild(a),1==t.Passed&&r.classList.add("grayed")}function createTimetable(e,t,n,i){let a=Date.now(),o=document.getElementById(e);for(var r=o.rows.length-1;r>0;r--)o.deleteRow(r);t.forEach(function(e){0==n&&0==e.Stopping||timetableRow(o,e)});let s=findNextStation(t);document.getElementById("NextStation").innerHTML=null!=s?UICCodeToStationName(s,trainStations):"-",document.getElementById("ArrivalTime").innerHTML=prettyTime(t[t.length-1].ScheduledArrival),document.getElementById("RealArrival").innerHTML=prettyTime(t[t.length-1].ActualArrival);let l=t[t.length-1];if(0!=l.ArrivalDifference?l.ArrivalDifference>0?(document.getElementById("Delay").innerHTML=l.ArrivalDifference,document.getElementById("Delay").classList.add("red"),document.getElementById("Delay").classList.remove("green"),document.getElementById("DelayText").innerHTML="Myöhässä: "):(document.getElementById("Delay").innerHTML=-l.ArrivalDifference,document.getElementById("Delay").classList.add("green"),document.getElementById("Delay").classList.remove("red"),document.getElementById("DelayText").innerHTML="Etuajassa: "):(document.getElementById("Delay").innerHTML="0",document.getElementById("Delay").classList.remove("red"),document.getElementById("Delay").classList.remove("green"),document.getElementById("DelayText").innerHTML="Etuajassa: "),1==oneTrain){let e=document.createElement("table"),n=e.insertRow(-1);n.insertCell(-1).appendChild(document.createTextNode("Asema")),n.insertCell(-1).appendChild(document.createTextNode("Syy")),n.classList.add("lihava"),t.forEach(function(t){if(t.Causes.length>0){let i=e.insertRow(-1),a=i.insertCell(-1);a.appendChild(document.createTextNode(UICCodeToStationName(t.UICCode,trainStations))),a.classList.add("lihava");let o=i.insertCell(-1),r=t.Causes[0].thirdCategoryCodeId,s=t.Causes[0].detailedCategoryCodeId,l=t.Causes[0].categoryCodeId;if(null!=r)if(null!=(n=KolmannenTasonSyykoodit.find(function(e){return e.id==r})))o.appendChild(document.createTextNode(n.thirdCategoryName));else if(null!=(n=Syykoodit.find(function(e){return e.id==s})))o.appendChild(document.createTextNode(n.detailedCategoryName));else{var n=Syyluokat.find(function(e){return e.id==l});o.appendChild(document.createTextNode(n.categoryName))}else if(null!=(n=Syykoodit.find(function(e){return e.id==s})))o.appendChild(document.createTextNode(n.detailedCategoryName));else{n=Syyluokat.find(function(e){return e.id==l});o.appendChild(document.createTextNode(n.categoryName))}document.getElementById("syyt").innerHTML="",document.getElementById("syyt").appendChild(e)}})}let d=Date.now()-a;console.log("Timetable time: "+new Date(d).getMilliseconds()+" ms")}function updateInfoBox(e){let t,n=JSON.parse(e);switch(document.getElementById("trainNumber").innerHTML=n[0].trainType+" "+n[0].trainNumber,document.getElementById("operator").innerHTML=n[0].operatorShortCode,n[0].trainCategory){case"Long-distance":t="Kaukoliikenne";break;case"Commuter":t="lähiliikenne";break;case"Cargo":t="Tavaraliikenne";break;case"Locomotive":t="Veturi";break;default:t=n[0].trainCategory}document.getElementById("category").innerHTML=t,document.getElementById("mistämihin").innerHTML=UICCodeToStationName(n[0].timeTableRows[0].stationUICCode,trainStations)+" - "+UICCodeToStationName(n[0].timeTableRows[n[0].timeTableRows.length-1].stationUICCode,trainStations)}function changeMap(e){switch(e){case"railwayMap":map.setStyle("mapbox://styles/nomatiti/cjh3f0hvg0v572spc6pnol7yj");break;case"streets":map.setStyle("mapbox://styles/mapbox/streets-v9");break;case"bright":map.setStyle("mapbox://styles/mapbox/bright-v9");break;case"satellite":map.setStyle("mapbox://styles/mapbox/satellite-streets-v9");break;case"Light":map.setStyle("mapbox://styles/mapbox/light-v9");break;case"Dark":map.setStyle("mapbox://styles/mapbox/dark-v9")}}function searchPressed(){let e=isNaN(document.getElementById("searchInputBox").value);window.location=0==e?"./juna.html?train="+document.getElementById("searchInputBox").value:"./asema.html?station="+document.getElementById("searchInputBox").value}function findNextStation(e){for(var t=1;t<e.length;t++)if(0==e[t].Passed&&1==e[t-1].Passed)return e[t].UICCode}function GeoJSONvessel(e){return'{"type":"Feature","properties":{"Mmsi":'+e.Mmsi+',"Cog":'+e.Cog+',"Destination":"'+e.Destination+'","Draught":'+e.Draught+',"Eta":'+e.Eta+',"Heading":'+e.Heading+',"Name":"'+e.Name+'","Rot":'+e.Rot+',"Callsign":"'+e.Callsign+'","Sog":'+e.Sog+'},"geometry":'+GeoJSONgeometry(e.Lat,e.Long)+"}"}function GeoJSONvesselCollection(e){let t='{"type":"FeatureCollection","features":[';if(0!=e.length){t+=GeoJSONvessel(e[0]);for(var n=1;n<e.length;n++)t=t+","+GeoJSONvessel(e[n])}return t+="]}"}function updateHSLarray(e,t,n){let i="";"bus/"==t.slice(24,28)?i="Bussi":"tram"==t.slice(24,28)?i="Raitiovaunu":"train"==t.slice(24,29)&&(i="Lähijuna");let a=new HSL(i,e.desi,e.dir,e.oper,e.veh,e.tst,e.spd,e.hdg,e.lat,e.long,e.acc,e.dl,e.odo,e.drst,e.start,t.split("/")[10]),o=searchHSLFromArray(a.HSLidentifier,n);null==o?n.push(a):n[o]=a,a.HSLidentifier==selectedHSL&&(console.log(a),updateSidePanelHSL(a))}function searchHSLFromArray(e,t){for(i=0;i<t.length;i++)if(t[i].HSLidentifier==e)return i}function GeoJSON_HSL(e){return'{"type":"Feature","properties":{"Type":"'+e.Type+'","Desi":"'+e.Desi+'","Dir":'+e.Dir+',"Oper":'+e.Oper+',"Veh":'+e.Veh+',"Spd":'+e.Spd+',"Hdg":'+e.Hdg+',"Acc":'+e.Acc+',"Dl":'+e.Dl+',"Odo":'+e.Odo+',"Drst":'+e.Drst+',"Identifier":"'+e.HSLidentifier+'"},"geometry":'+GeoJSONgeometry(e.Lat,e.Long)+"}"}function GeoJSON_HSLCollection(e){let t='{"type":"FeatureCollection","features":[';if(0!=e.length){t+=GeoJSON_HSL(e[0]);for(var n=1;n<e.length;n++)t=t+","+GeoJSON_HSL(e[n])}return t+="]}"}function updateSidePanelHSL(e){let t;switch("Ladataan..."==e.Dest?document.getElementById("name").innerHTML=e.Dest:document.getElementById("name").innerHTML="Linja: "+e.Desi+":"+e.Dest,document.getElementById("category").innerHTML=e.Type,document.getElementById("linja").innerHTML=e.Desi,e.Oper){case 6:t="Oy Pohjolan Liikenne Ab";break;case 12:t="Helsingin Bussiliikenne Oy";break;case 17:t="Tammelundin Liikenne Oy";break;case 18:t="Pohjolan Kaupunkiliikenne Oy";break;case 19:t="Etelä-Suomen Linjaliikenne Oy";break;case 20:t="Bus Travel Åbergin Linja Oy";break;case 21:t="Bus Travel Oy Reissu Ruoti";break;case 22:t="Nobina Finland Oy";break;case 36:t="Nurmijärven Linja Oy";break;case 40:t="HKL-Raitioliikenne";break;case 45:t="Transdev Vantaa Oy";break;case 47:t="Taksikuljetus Oy";break;case 51:t="Korsisaari Oy";break;case 54:t="V-S Bussipalvelut Oy";break;case 55:t="Transdev Helsinki Oy";break;case 58:t="Koillisen Liikennepalvelut Oy";break;case 59:t="Tilausliikenne Nikkanen Oy";break;case 90:t="VR Oy";break;default:t="-"}document.getElementById("operator").innerHTML=t,document.getElementById("Speed").innerHTML=(3.6*e.Spd).toFixed(1),document.getElementById("Acc").innerHTML=e.Acc,0==e.Drst?document.getElementById("Doors").innerHTML="kiinni":1==e.Drst?document.getElementById("Doors").innerHTML="auki":document.getElementById("Doors").innerHTML="-",e.Dl>=0?(document.getElementById("Delay").innerHTML=e.Dl,document.getElementById("DelayText").innerHTML="Etuajassa: ",document.getElementById("Delay").classList.remove("red"),document.getElementById("Delay").classList.add("green")):(document.getElementById("Delay").innerHTML=e.Dl,document.getElementById("DelayText").innerHTML="jäljessä: ",document.getElementById("Delay").classList.add("red"),document.getElementById("Delay").classList.remove("green")),document.getElementById("lähti").innerHTML=e.Start}HttpReq("https://rata.digitraffic.fi/api/v1/metadata/stations",function(){trainStations=JSON.parse(this.responseText)});